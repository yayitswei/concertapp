<html>

  <head>
    <script src="http://code.jquery.com/jquery.min.js"></script>
  </head>
  <body>
    <p>
      Estimated server time: <span id='server-time'></span>
    </p>
    <p>
      Local difference: <span id='difference'></span>
    </p>
    <p>
      Last RTT: <span id='last-rtt'></span>ms
    </p>
    <p>
      Shortest RTT: <span id='shortest-rtt'></span>ms
    </p>
    <p>
      Last fetched server time: <span id='last-server-time'></span>ms
    </p>

    <script>
      var requestAnimationFrame = (function(){
          return  window.requestAnimationFrame       ||
                  window.webkitRequestAnimationFrame ||
                  window.mozRequestAnimationFrame    ||
                  window.oRequestAnimationFrame      ||
                  window.msRequestAnimationFrame     ||
                  function( callback ){
                    window.setTimeout(function() { callback(Date.now()); }, 1000 / 60);
                  };
        })();

      var serverTimeDifference = 0;
      var lastServerTime = 0;
      var lastRtt = 0;
      var shortestRtt;

      function cycle(t, freq) {
        return Math.round((255/2) * Math.sin(freq * t) + (255/2));
      }

      function changeColor(clientTime) {
        var serverTime = clientTime + serverTimeDifference;

        $("body").css("background-color", "rgb(" + cycle(serverTime, 0.001) + ", " + cycle(serverTime, 0.0005) + ", " + cycle(serverTime, 0.002) + ")");
        $("#server-time").text(Math.round(serverTime/1000));
        $("#last-rtt").text(lastRtt);
        $("#shortest-rtt").text(shortestRtt);
        $("#difference").text(serverTimeDifference);
        $("#last-server-time").text(lastServerTime);

        requestAnimationFrame(changeColor);
      }

      function syncClock() {
        var start = Date.now();
        var xhr = $.getJSON('/time.json');
        xhr.done(function(response) {
          var clientTimeNow = Date.now();
          lastRtt = (clientTimeNow - start);

          // Don't bother with a less accurate time
          if (shortestRtt && shortestRtt < lastRtt) {
            return;
          }

          shortestRtt = lastRtt;
          lastServerTime = parseFloat(response['time']) * 1000;
          var serverTimeNow = lastServerTime + lastRtt/2;
          serverTimeDifference = serverTimeNow - clientTimeNow;
        });
      }

      syncClock();
      setInterval(syncClock, 5000);

      requestAnimationFrame(changeColor);
    </script>
  </body>
</html>
