<html>

  <head>
    <script src="http://code.jquery.com/jquery.min.js"></script>
  </head>
  <body>
    <p id="time">123123</p>
    <script>
      var requestAnimationFrame = (function(){
          return  window.requestAnimationFrame       ||
                  window.webkitRequestAnimationFrame ||
                  window.mozRequestAnimationFrame    ||
                  window.oRequestAnimationFrame      ||
                  window.msRequestAnimationFrame     ||
                  function( callback ){
                    window.setTimeout(function() { callback(Date.now()); }, 1000 / 60);
                  };
        })();

      var serverTimeDifference = 0;

      function cycle(t, freq) {
        return Math.round((255/2) * Math.sin(freq * t) + (255/2));
      }

      function changeColor(clientTime) {
        clientTime += serverTimeDifference;

        $("body").css("background-color", "rgb(" + cycle(clientTime, 0.001) + ", " + cycle(clientTime, 0.0005) + ", " + cycle(clientTime, 0.002) + ")");
        $("#time").text(Math.round(clientTime/1000));

        requestAnimationFrame(changeColor);
      }

      function syncClock() {
        var start = Date.now();
        var xhr = $.getJSON('/time.json');
        xhr.done(function(response) {
          var clientTimeNow = Date.now();
          var lag = clientTimeNow - start;

          var serverTimeThen = response['time'] * 1000;
          var serverTimeNow = serverTimeThen + (lag/2);
          serverTimeDifference = serverTimeNow - clientTimeNow;
          console.log("Time difference: " + serverTimeDifference);
        });
      }
      setInterval(syncClock, 5000);

      requestAnimationFrame(changeColor);
    </script>
  </body>
</html>
